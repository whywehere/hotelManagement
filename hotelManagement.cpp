#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
 // ?????????з??????????
typedef struct HotelRoomInfo {
    char room_type[50];       // ????????
    double room_price;        // ??????
    int total_rooms;          // ???????
    int remaining_rooms;      // ???????
    struct HotelRoomInfo* next;   // ??????????????????????
} HotelRoomInfo;

// ????????????????????
typedef struct CustomerRoomInfo {
    char room_type[50];       // ????????
    double room_price;        // ??????
    struct CustomerRoomInfo* next;   // ?????????????????????????
} CustomerRoomInfo;

// ?????????????
typedef struct Customer {
    char name[100];           // ???????
    char phone[20];           // ????绰
    char gender;              // ??????
    char check_in_date[20];   // ??????????
    CustomerRoomInfo* room_info; // ????????????????????
    char booking_time[80];    // ???????
    double total_price;       // ???????
    struct Customer* next;    // ?????????????????????
} Customer;

Customer* customer_head = NULL;  // ????????????????

/**
* ??????з??? operations 
*/ 
HotelRoomInfo* hotel_room_head = NULL; // ??????????????????


// ????????????????? 
void addRoomType(const char* roomType, double price, int totalRooms, int remaining_rooms) {
    HotelRoomInfo* newRoom = (HotelRoomInfo*)malloc(sizeof(HotelRoomInfo));
    
    strcpy(newRoom->room_type, roomType);
    newRoom->room_price = price;
    newRoom->total_rooms = totalRooms; 
    newRoom->remaining_rooms = remaining_rooms;
    newRoom->next = NULL;

    if (hotel_room_head == NULL) {
        hotel_room_head = newRoom;
    } else {
    	// ??????????β?? ???????????????β?? 
        HotelRoomInfo* current = hotel_room_head;
        while (current->next != NULL) {
            current = current->next;
        }
        current->next = newRoom;
    }
}
// ??????? 
void removeRoomType(const char* roomType) {
    HotelRoomInfo* current = hotel_room_head;
    HotelRoomInfo* prev = NULL; // prev??????????????? 

    while (current != NULL) {
        if (strcmp(current->room_type, roomType) == 0) { // ????????????????? 
            if (prev == NULL) {  
                hotel_room_head = current->next;
            } else {
                prev->next = current->next;
            }
            free(current); // ??????? 
            return;
        }
        prev = current;
        current = current->next;
    }
}
// ???????????????? 
void saveRoomInfoToFile() {
    FILE* fp = fopen("room_info.txt", "w");
    if (fp == NULL) {
        printf("?????????????????!\n");
        return;
    }

    HotelRoomInfo* current = hotel_room_head; // ????????, ???????????????δ?????? 
    while (current != NULL) {
        fprintf(fp, "%s %.2lf %d %d\n", current->room_type, current->room_price, current->total_rooms, current->remaining_rooms);
        current = current->next;
    }

    fclose(fp);
    printf("??????淿??????????!\n");
}

// ?????з?????? 
void displayRoomTypes() {
    HotelRoomInfo* current = hotel_room_head;

    printf("???з??????:\n");
    while (current != NULL) {
        printf("????????: %s, ??????: %.2lf, ???????: %d, ???????: %d\n",
               current->room_type, current->room_price, current->total_rooms, current->remaining_rooms);
        current = current->next;
    }
}


/** 
* ???????
*/ 
 
void insertCustomerNode(Customer newCustomer) {
    // ????????
    Customer* newNode = (Customer*)malloc(sizeof(Customer));
    *newNode = newCustomer;
    newNode->next = NULL;

    // ????????????????????????
    if (customer_head == NULL) {
        customer_head = newNode;
        return;
    }

    // ????????????????????????????????β
    Customer* current = customer_head;
    while (current->next != NULL) {
        current = current->next;
    }
    current->next = newNode;
}

void saveCustomersToFile() {
    FILE* fp = fopen("customers.txt", "w");
    if (fp == NULL) {
        printf("????????????????!\n");
        return;
    }

    Customer* current = customer_head;
    while (current != NULL) {
        fprintf(fp, "%s %s %c %s %s", current->name, current->phone, current->gender, current->check_in_date, current->booking_time);

        // ????????????????????????????洢???????
        CustomerRoomInfo* roomInfo = current->room_info;
        while (roomInfo != NULL) {
            fprintf(fp, " %s %.2lf", roomInfo->room_type, roomInfo->room_price);
            roomInfo = roomInfo->next;
        }

        fprintf(fp, " %.2lf\n", current->total_price);

        current = current->next;
    }

    fclose(fp);
    printf("?????????????????!\n");
}



void loadRoomInfoFromFile() {
	// ???????????????? 
    FILE* fp = fopen("customers.txt", "r");
	if (fp == NULL) {
	    printf("δ???????????????????????!\n");
	    return;
	}
	
	while (!feof(fp)) {
	    Customer newCustomer;
	
	    // ?????????????
	    int result = fscanf(fp, "%s %s %c %s %s",
	                        newCustomer.name,
	                        newCustomer.phone,
	                        &newCustomer.gender,
	                        newCustomer.check_in_date,
	                        newCustomer.booking_time);
	
	    // ????????????????????
	    newCustomer.room_info = NULL;
	
	    // ???????????????
	    double total_price = 0.0;
	    char roomType[50];
	    double roomPrice;
	
	    // ???????????????????
	    while (fscanf(fp, "%s %lf", roomType, &roomPrice) == 2) {
	        total_price += roomPrice;
	
	        // ???????????????????????????????
	        CustomerRoomInfo* newRoom = (CustomerRoomInfo*)malloc(sizeof(CustomerRoomInfo));
	        strcpy(newRoom->room_type, roomType);
	        newRoom->room_price = roomPrice;
	        newRoom->next = NULL;
	
	        if (newCustomer.room_info == NULL) {
	            newCustomer.room_info = newRoom;
	        } else {
	            CustomerRoomInfo* temp = newCustomer.room_info;
	            while (temp->next != NULL) {
	                temp = temp->next;
	            }
	            temp->next = newRoom;
	        }
	    }
	
	    newCustomer.total_price = total_price;
	
	    // ????????????????
	    insertCustomerNode(newCustomer);
	}
	
	fclose(fp);



    
    // ?????????з???????? 
    fp = fopen("room_info.txt", "r");
    if (fp == NULL) {
        printf("δ????????????????????????!\n");
        return;
    }

    while (!feof(fp)) {
        char roomType[50];
        double price;
        int totalRooms, remainingRooms;

        if (fscanf(fp, "%s %lf %d %d\n", roomType, &price, &totalRooms, &remainingRooms) == 4) {
            addRoomType(roomType, price, totalRooms, remainingRooms);
        }
    }

    fclose(fp);
}

void displayCustomerInfo() {
    Customer* current = customer_head;

    while (current != NULL) {
        printf("???????: %s\n", current->name);
        printf("????绰: %s\n", current->phone);
        printf("??????: %c\n", current->gender);
        printf("???????: %s\n", current->check_in_date);
        printf("???????: %s\n", current->booking_time);
		printf("????: %.2lf\n", current->total_price);
        // ?????????????????????????????
        CustomerRoomInfo* roomInfo = current->room_info;
        printf("?????????????:\n");
        while (roomInfo != NULL) {
            printf("????????: %s, ??????: %.2lf\n", roomInfo->room_type, roomInfo->room_price);
            roomInfo = roomInfo->next;
        }

        printf("--------------------\n");
        current = current->next;
    }
}


void bookRoom() {
	// ????????????з??? 
	displayRoomTypes();
	 
    Customer newCustomer;
    newCustomer.room_info = NULL; // ????????????????

    printf("??????????: ");
    scanf("%s", newCustomer.name);

    printf("??????绰????: ");
    scanf("%s", newCustomer.phone);

    printf("?????????(M/F): ");
    scanf(" %c", &newCustomer.gender);

    printf("?????????????: ");
    scanf("%s", newCustomer.check_in_date);
	
//	 ???????????????? 
	time_t rawtime;
	struct tm *timeinfo;
    time(&rawtime);
	timeinfo = localtime(&rawtime);
	
    char bookingTime[200];  // ???? booking_time ????? char ????
	strftime(bookingTime, sizeof(bookingTime), "%Y-%m-%d-%H:%M:%S", timeinfo);
	
	sprintf(newCustomer.booking_time, "%s", bookingTime);
	

    // ?????????????????????????????????????????
    int moreRooms = 1;
    do {
        CustomerRoomInfo* newRoomInfo = (CustomerRoomInfo*)malloc(sizeof(CustomerRoomInfo));
        printf("????????????: ");
        scanf("%s", newRoomInfo->room_type);
        newRoomInfo->next = NULL;

        // ???????в????????????????????
        HotelRoomInfo* currentRoom = hotel_room_head;
        while (currentRoom != NULL) {
            if (strcmp(currentRoom->room_type, newRoomInfo->room_type) == 0) {
                // ?????????????????????????????
                strcpy(newRoomInfo->room_type, currentRoom->room_type);
                newRoomInfo->room_price = currentRoom->room_price;
                
				newCustomer.total_price += currentRoom->room_price;
				currentRoom->remaining_rooms -= 1;
                // ????????????????????????????
                if (newCustomer.room_info == NULL) {
                    newCustomer.room_info = newRoomInfo;
                } else {
                    CustomerRoomInfo* current = newCustomer.room_info;
                    while (current->next != NULL) {
                        current = current->next;
                    }
                    current->next = newRoomInfo;
                }
                break;
            }
            currentRoom = currentRoom->next;
        }

        printf("???и???????????(1-???0-??): ");
        scanf("%d", &moreRooms);
    } while (moreRooms);

    // ??????????????????????????
    insertCustomerNode(newCustomer);

    // ?????????????浽???
    saveCustomersToFile();
    saveRoomInfoToFile();
}
// ??????????????????????????? 
void sortCustomersByTotalPrice() {
    if (customer_head == NULL || customer_head->next == NULL) {
        return; // ?????????????????????????
    }

    int swapped;
    Customer *temp = NULL;

    do {
        swapped = 0;
        Customer *current = customer_head;
        while (current->next != NULL) {
            if (current->total_price > current->next->total_price) {
                // ???????λ??
                if (current == customer_head) {
                    customer_head = current->next;
                } else {
                    temp->next = current->next;
                }

                temp = current->next;
                current->next = temp->next;
                temp->next = current;
                swapped = 1;
            } else {
                temp = current;
                current = current->next;
            }
        }
    } while (swapped);
}

int main() {
	
    loadRoomInfoFromFile(); 
    
    int choice;
    do {
       	printf("\n?X?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?[\n");
		printf("?U         ????????             ?U\n");
		printf("?d?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?g\n");
		printf("?U 1. ????                          ?U\n");
		printf("?U 2. ?????з??????              ?U\n");
		printf("?U 3. ?????????                  ?U\n");
		printf("?U 4. ??????????                  ?U\n");
		printf("?U 5. ????????????              ?U\n");
		printf("?U 6. ?????????????              ?U\n");
		printf("?U 7. ???                          ?U\n");
		printf("?^?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?T?a\n");
		printf("????????: ");
		scanf("%d", &choice);
        switch (choice) {
            case 1:
                bookRoom();
                break;
            case 2:
                displayRoomTypes();
                break;
            case 3:
                {
                    char roomType[50];
                    double price;
                    int totalRooms;

                    printf("??????????????????: ");
                    scanf("%s", roomType);
                    printf("????????: ");
                    scanf("%lf", &price);
                    printf("?????????????: ");
                    scanf("%d", &totalRooms);

                    addRoomType(roomType, price, totalRooms, totalRooms);
                    saveRoomInfoToFile(); // ???浽???
                }
                break;
            case 4:
                {
                    char roomTypeToRemove[50];
                    printf("???????????????????: ");
                    scanf("%s", roomTypeToRemove);

                    removeRoomType(roomTypeToRemove);
                    saveRoomInfoToFile(); // ???浽???
                }
                break;
            case 5: 
            	displayCustomerInfo();
				break; 
            case 6:
            	sortCustomersByTotalPrice();
            	displayCustomerInfo();
            	break;
			case 7:
                saveRoomInfoToFile(); // ???浽???
                exit(0);
            default:
                printf("??Ч?????!\n");
        }
    } while (choice != 7);

    return 0;
}




